<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é—œå¡å››ï¼šæ‹¼å‡ºå®¶åœ’</title>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    h1 {
      margin-bottom: 10px;
    }
    #puzzle {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 2px;
    }
    .piece {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .hidden {
      visibility: hidden;
    }
    #controls {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #message {
      font-size: 18px;
      margin-bottom: 10px;
    }
    #nextBtn, #resetBtn {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #nextBtn {
      background-color: #4caf50;
      color: white;
      display: none;
    }
    #resetBtn {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>

<!-- ğŸµ èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgMusic" src="music.mp3" autoplay loop></audio>
<script>
  const bgMusic = document.getElementById("bgMusic");
  bgMusic.volume = 0.3;
</script>

<h1>é—œå¡å››ï¼šæ‹¼å‡ºå®¶åœ’</h1>
<div id="puzzle"></div>
<div id="controls">
  <div id="message">è«‹å°‡æ‹¼åœ–æ‹¼å›åŸä½ï¼</div>
  <button id="nextBtn" onclick="location.href='level5.html'">ä¸‹ä¸€é—œ</button>
  <button id="resetBtn" onclick="initPuzzle()">é‡æ–°é–‹å§‹</button>
</div>

<script>
  const puzzle = document.getElementById("puzzle");
  const nextBtn = document.getElementById("nextBtn");
  const message = document.getElementById("message");

  const size = 3;
  const total = size * size;
  const imageFiles = Array.from({ length: total }, (_, i) =>
    `images/å·¦_${String(i + 1).padStart(2, '0')}.png`
  );

  let pieces = [];

  function isSolvable(array) {
    let invCount = 0;
    for (let i = 0; i < array.length; i++) {
      for (let j = i + 1; j < array.length; j++) {
        if (array[i] !== total - 1 && array[j] !== total - 1 && array[i] > array[j]) {
          invCount++;
        }
      }
    }
    return invCount % 2 === 0;
  }

  function shuffle(array) {
    do {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    } while (!isSolvable(array));
  }

  function initPuzzle() {
    puzzle.innerHTML = "";
    pieces = [];
    nextBtn.style.display = "none";
    message.textContent = "è«‹å°‡æ‹¼åœ–æ‹¼å›åŸä½ï¼";

    const positions = Array.from({ length: total }, (_, i) => i);
    shuffle(positions);

    positions.forEach((imgIndex, targetIndex) => {
      const img = document.createElement("img");
      img.className = "piece";
      img.dataset.current = imgIndex;
      img.dataset.correct = targetIndex;

      img.src = imageFiles[imgIndex];
      if (imgIndex === total - 1) {
        img.classList.add("hidden");
      }

      img.addEventListener("click", () => {
        const empty = pieces.find(p => parseInt(p.dataset.current) === total - 1);
        const from = pieces.indexOf(img);
        const to = pieces.indexOf(empty);

        const dx = Math.abs((from % size) - (to % size));
        const dy = Math.abs(Math.floor(from / size) - Math.floor(to / size));

        if ((dx === 1 && dy === 0) || (dx === 0 && dy === 1)) {
          [img.dataset.current, empty.dataset.current] = [empty.dataset.current, img.dataset.current];
          [img.src, empty.src] = [empty.src, img.src];
          img.classList.add("hidden");
          empty.classList.remove("hidden");

          checkCompletion();
        }
      });

      pieces.push(img);
      puzzle.appendChild(img);
    });
  }

  function checkCompletion() {
    const isCorrect = pieces.every((img, i) =>
      parseInt(img.dataset.current) === parseInt(img.dataset.correct)
    );
    if (isCorrect) {
      message.textContent = "ğŸ‰ æ‹¼åœ–å®Œæˆï¼";
      nextBtn.style.display = "inline-block";
    }
  }

  initPuzzle();
</script>

</body>
</html>
