<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é—œå¡ä¸‰ï¼šè¾¨è­˜å¤–ä¾†ç¨®</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: url('images/grass.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    #introScreen, #endScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
      text-align: center;
      padding: 30px;
    }

    #startBtn, #restartBtn, #nextBtn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }

    #startBtn { background-color: #4caf50; }
    #restartBtn { background-color: #f44336; display: none; }
    #nextBtn { background-color: #2196f3; display: none; }

    .animal {
      position: absolute;
      width: 180px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    #scoreBoard {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 18px;
      z-index: 10;
    }

    #guide {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 6px;
      border-radius: 10px;
      z-index: 30;
      user-select: none;
    }

    #guide img {
      width: 48px;
      height: 48px;
      cursor: pointer;
      border-radius: 6px;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }

    #guide img:hover {
      border-color: #2196f3;
    }

    #popupOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #popupImage {
      max-width: 80vw;
      max-height: 80vh;
      border: 5px solid white;
      border-radius: 12px;
      box-shadow: 0 0 20px white;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>

<!-- ğŸµ èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgMusic" src="music.mp3" loop></audio>
<script>
  const bgMusic = document.getElementById('bgMusic');
  bgMusic.volume = 0.3;
</script>

<div id="introScreen">
  <h1>é—œå¡ä¸‰ï¼šè¾¨è­˜å¤–ä¾†ç¨®</h1>
  <p>è‰åŸä¸­å†’å‡ºå„ç¨®å‹•ç‰©ï¼Œåœ¨ 30 ç§’å…§é»æ“Šå¤–ä¾†ç¨®ä¾†å¾—åˆ†ã€‚</p>
  <p>èª¤é»æœ¬åœŸç¨®æœƒæ‰£åˆ†å–”ï¼</p>
  <button id="startBtn">é–‹å§‹éŠæˆ²</button>
</div>

<div id="scoreBoard">
  åˆ†æ•¸ï¼š<span id="score">0</span><br>
  æ™‚é–“ï¼š<span id="time">30</span> ç§’
</div>

<div id="guide" title="é»æ“Šåœ–ç‰‡æ”¾å¤§">
  <img id="guideImage" src="images/åœ–é‘‘.jpg" alt="å‹•ç‰©åœ–ç¤º" />
</div>

<div id="popupOverlay">
  <img id="popupImage" src="" alt="æ”¾å¤§å‹•ç‰©åœ–ç‰‡" />
</div>

<div id="endScreen" style="display:none;">
  <h2>æ™‚é–“åˆ°ï¼</h2>
  <p id="finalScore"></p>
  <button id="restartBtn">é‡æ–°æŒ‘æˆ°</button>
  <button id="nextBtn">ä¸‹ä¸€é—œ</button>
</div>

<script>
  const animals = [
    { name: 'æ²™æ°è®Šè‰²èœ¥', src: 'images/æ²™æ°è®Šè‰²èœ¥.png', invasive: true },
    { name: 'ç¶ é¬£èœ¥', src: 'images/ç¶ é¬£èœ¥.png', invasive: true },
    { name: 'ç¶ æ°´é¾', src: 'images/ç¶ æ°´é¾.png', invasive: true },
    { name: 'æ–‘è…¿æ¨¹è›™', src: 'images/æ–‘è…¿æ¨¹è›™.png', invasive: true },
    { name: 'å°ç£çŸ³è™', src: 'images/å°ç£çŸ³è™.png', invasive: false },
    { name: 'å°ç£é»‘ç†Š', src: 'images/å°ç£é»‘ç†Š.png', invasive: false },
    { name: 'èµ¤è…¹æ¸¸è›‡', src: 'images/èµ¤è…¹æ¸¸è›‡.png', invasive: false }
  ];

  const guideImage = document.getElementById('guideImage');
  const popupOverlay = document.getElementById('popupOverlay');
  const popupImage = document.getElementById('popupImage');
  const scoreSpan = document.getElementById('score');
  const timeSpan = document.getElementById('time');
  const introScreen = document.getElementById('introScreen');
  const endScreen = document.getElementById('endScreen');
  const restartBtn = document.getElementById('restartBtn');
  const nextBtn = document.getElementById('nextBtn');

  let score = 0;
  let spawnInterval;
  let timeLeft = 30000;
  let timerStart;
  let timerRemaining = timeLeft;
  let gamePaused = false;

  guideImage.addEventListener('click', (e) => {
    e.stopPropagation();
    showPopup(guideImage.src, guideImage.alt);
  });

  function showPopup(src, alt) {
    pauseGame();
    popupImage.src = src;
    popupImage.alt = alt;
    popupOverlay.style.display = 'flex';
  }

  function hidePopup() {
    popupOverlay.style.display = 'none';
    resumeGame();
  }

  popupOverlay.addEventListener('click', (e) => {
    if (e.target === popupOverlay) {
      hidePopup();
    }
  });

  popupImage.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  document.getElementById('startBtn').onclick = () => {
    introScreen.style.display = 'none';
    bgMusic.play().catch(() => console.warn("éŸ³æ¨‚æœªæ’­æ”¾ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶"));
    startGame();
  };

  restartBtn.onclick = () => location.reload();
  nextBtn.onclick = () => location.href = 'level4.html';

  function startGame() {
    score = 0;
    scoreSpan.textContent = score;
    timeLeft = 30000;
    timerRemaining = timeLeft;
    timeSpan.textContent = Math.ceil(timeLeft / 1000);
    endScreen.style.display = 'none';

    startTimer();
    spawnInterval = setInterval(spawnAnimal, 800);
  }

  function startTimer() {
    timerStart = performance.now();
    requestAnimationFrame(timerTick);
  }

  function timerTick() {
    if (timerRemaining <= 0) {
      timeSpan.textContent = '0';
      endGame();
      return;
    }
    if (!gamePaused) {
      const now = performance.now();
      const elapsed = now - timerStart;
      timerRemaining -= elapsed;
      timerStart = now;
      timeSpan.textContent = Math.ceil(timerRemaining / 1000);
    }
    requestAnimationFrame(timerTick);
  }

  function pauseGame() {
    if (!gamePaused) {
      gamePaused = true;
      clearInterval(spawnInterval);
    }
  }

  function resumeGame() {
    if (gamePaused) {
      gamePaused = false;
      timerStart = performance.now();
      spawnInterval = setInterval(spawnAnimal, 800);
    }
  }

  function spawnAnimal() {
    const animal = animals[Math.floor(Math.random() * animals.length)];
    const img = document.createElement('img');
    img.src = animal.src;
    img.alt = animal.name;
    img.className = 'animal';

    let x = Math.random() * (window.innerWidth - 100);
    let y = Math.random() * (window.innerHeight - 200) + 100;
    img.style.left = `${x}px`;
    img.style.top = `${y}px`;

    img.onclick = () => {
      if (animal.invasive) {
        score++;
      } else {
        score--;
      }
      scoreSpan.textContent = score;
      img.remove();
    };

    document.body.appendChild(img);

    setTimeout(() => {
      if (img.parentNode) img.remove();
    }, 1200);
  }

  function removeAllAnimals() {
    document.querySelectorAll('.animal').forEach(el => el.remove());
  }

  function endGame() {
    clearInterval(spawnInterval);
    removeAllAnimals();
    endScreen.style.display = 'flex';
    document.getElementById('finalScore').textContent = `ä½ çš„æœ€çµ‚åˆ†æ•¸ï¼š${score}`;

    if (score >= 10) {
      nextBtn.style.display = 'inline-block';
      restartBtn.style.display = 'none';
    } else {
      nextBtn.style.display = 'none';
      restartBtn.style.display = 'inline-block';
    }
  }
</script>

</body>
</html>
